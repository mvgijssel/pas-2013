import basebehavior.behaviorimplementation
import time
import random

nao = False

class searchball_x(basebehavior.behaviorimplementation.BehaviorImplementation):

    '''This behavior will move the Nao around until the ball is seen in the middle of the FoV.'''

    #this implementation should not define an __init__ !!!


    def implementation_init(self):
        self.nao = self.body.nao(0)
        self.nao.say("Lets find the ball!")
        self.start_time = time.time()
        if nao: self.nao.set_cam_vars()
        
        #Make sure the robot is standing and looks horizontal:
        self.nao.start_behavior("standup")
        if nao: self.nao.look_horizontal()

        self.last_recogtime = time.time()
        self.looktime = time.time()

        self.state = "Standing"


    def implementation_update(self):
        # Turn around in a certain direction unless you see the ball.
        # In that case, turn towards it until you have it fairly central in the Field of Vision.
        
        if self.state == "Standing" and (time.time() - self.looktime) > 4:   
            print "Looking Right"
            self.looktime = time.time()
            self.nao.start_behavior("rag_look_right")
            self.state = "Right"
               
        if self.state == "Right" and (time.time() - self.looktime) > 4:   
            print "Looking Left"
            self.looktime = time.time()
            self.nao.start_behavior("rag_look_left")
            self.state = "Left"

        if self.state == "Left" and (not nao or not self.nao.isMoving()):       
            print "Moving clockwise"
            self.temptime = time.time()
            if nao: self.nao.WalkNav(0,0,-1.57,0.10)
            self.state = "Standing"

        #Try to see if there is a ball in sight:
        if (self.m.n_occurs("combined_red") > 0):
            (recogtime, obs) = self.m.get_last_observation("combined_red")
            if not obs == None and recogtime > self.last_recogtime:
                detectionlist = obs['sorted_contours']
                blob_max = detectionlist[0]
                print "red: x=%d, y=%d, size=%f" % (blob_max['x'], blob_max['y'], blob_max['surface'])
                self.last_recogtime = recogtime
                #Ball is found if the detected ball is big enough (thus filtering noise):
                if blob_max['surface'] > 50000:
                    #Ball was found while looking Right, Turning Right
                    if self.state == "Right":
                        print "We gaan naar Rechts draaien en dan fancy doen!"
                        if nao: self.nao.WalkNav(0,0,1,0.10)
                    #Ball was found while looking Left, Turning Left
                    if self.state == "Left":
                        print "We gaan naar Links draaien en dan fancy doen!"
                        if nao: self.nao.WalkNav(0,0,-1,0.10)
                    print "Ik zie de bal"
                    # Once the ball is properly found, use: self.m.add_item('ball_found',time.time(),{}) to finish this behavior.
                    self.m.add_item('searchball',time.time(),{})
